<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Airflow | Nikita Mashalov</title> <meta name="author" content="Nikita Mashalov"> <meta name="description" content="Article covers Airflow architecture for beginner enterprise ml team"> <meta name="keywords" content="Mashalov Nikita, machine learning, artificial intelligence, AI"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%94%AD&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nmashalov.github.io/blog/2024/airflow/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?6185d15ea1982787ad7f435576553d64"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Airflow",
      "description": "Article covers Airflow architecture for beginner enterprise ml team",
      "published": "January 10, 2024",
      "authors": [
        {
          "author": "Mashalov Nikita",
          "authorURL": "",
          "affiliations": [
            {
              "name": "MIPT",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Nikita Mashalov</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Airflow</h1> <p>Article covers Airflow architecture for beginner enterprise ml team</p> </d-title><d-byline></d-byline><d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="##Why%20care?"> Why care? </a></div> <div><a href="##tools"> Tools </a></div> <div><a href="##team"> Team </a></div> <div><a href="##code%20implementation">Code implementation</a></div> </nav> </d-contents> <p>Through year I had intensive work with Airflow as MLOps specialist. My primer task was to facilitate in-house Airflow provision. I’ll share ideas and setup, that</p> <p>Blog divided in three parts:</p> <ol> <li>Linkage between tools of versioning Gitlab, storage s3 and Airflow</li> <li>Covers responsibility delegation in team</li> <li>Suggest code for introduced concepts</li> </ol> <p>If you prefer, you can material on <a href="WIP">youtube</a> or look through <a href="https://docs.google.com/presentation/d/1ZDHUNOikAwtRWcU3ctK962KErVaah2iQ4PrRD5tZjr8/edit?usp=sharing" rel="external nofollow noopener" target="_blank">presentation</a></p> <h2 id="why-care">Why care?</h2> <p>Following chapter is pure introduction and inspiration. You can skip it freely, if you want :)</p> <h3 id="pipelines">Pipelines</h3> <p>Pipelining is an art of organization domain specific tools. They skill helps to fasten things a lot, since there are a lot of cool open source tools.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/pitch/pipe.excalidraw.png" alt="pipeline.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Pipelining is an art of organization</em></td> </tr> </tbody> </table> <p>Such pipes are handled by ‘glue’ shell scripting languages like bash</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> traced_images <span class="o">&amp;&amp;</span> <span class="nb">cat </span>img_path.txt | xargs <span class="nt">-I</span> <span class="o">{}</span> potrace <span class="o">{}</span> <span class="nt">-O</span> 
</code></pre></div></div> <p>Parallel with old tools like bash is essential as documentation of orchestration assumes that you have profficience with and recognized it’s limit. Mainly because such tools doesn’t go well beyond one machine and sysadmin. Therefore we need better tools</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/pitch/renormalisation.excalidraw.png" alt="groups.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Something more scalable</em></td> </tr> </tbody> </table> <h3 id="orchestration">Orchestration</h3> <p>Orchestration is a way of renormalizing pipelining on level of systems. It contains lot’s of pipelines and soon after srchestration tool are basically become project heart.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/pitch/essential.excalidraw.png" alt="groups.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Comes</em></td> </tr> </tbody> </table> <p>Therefore orchestrators come with tools of adaption to environment modification and wiring.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/pitch/tools.excalidraw.png" alt="renorm.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Renormalization</em></td> </tr> </tbody> </table> <h2 id="tools">Tools</h2> <p>Section will provide setup explanation and</p> <p>Before we start I’ll share some core concepts about Airflow.</p> <h3 id="airflow-brief-introduction">Airflow. Brief introduction</h3> <p>Apache Airflow is an open-source platform designed to programmatically compose pipeline, schedule them and monitor them in powerful UI. Main language is Python</p> <p>Basic primitive is a Directed Acyclic Graphs (DAGs).</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/tutorial/dag.excalidraw.png" alt="dag.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Intuitive representation of pipeline</em></td> </tr> </tbody> </table> <p>Nodes here represents action to executed, links it’s order.</p> <p>That abstraction is boosted with scheduling</p> <p>For better perception can be organized in groups.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/tutorial/groups.excalidraw.png" alt="groups.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Semantic organization</em></td> </tr> </tbody> </table> <p>By default operators are executed via <a href="https://docs.celeryq.dev/" rel="external nofollow noopener" target="_blank">Celery</a>, but can also be modified for running on <a href="https://airflow.apache.org/docs/apache-airflow-providers-cncf-kubernetes/stable/operators.html" rel="external nofollow noopener" target="_blank">Kubernetes</a>.</p> <p>You can learn more about Airflow from official documentation on <a href="https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html" rel="external nofollow noopener" target="_blank">DAG</a>. If you want to practice, you can also refer to my tutorial on starting with Airflow on toy OCR app <a href="https://github.com/NMashalov/Airflow_tutorial" rel="external nofollow noopener" target="_blank">Github Link</a>.</p> <p>I’ll warn you that from outbox Airflow:</p> <ul> <li>doesn’t provide any options for .</li> </ul> <h3 id="setup">Setup</h3> <p>In-house solution already done all all DevOps work of the deployment, configuration, and monitoring of Airflow instances. Provider ensured scalability, reliability, and performance.</p> <p>Pipelines are provided to Airflow via cli command, which can be executed both locally and</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/architecture/airflow_delivery.excalidraw.png" alt="s3_airflow.png"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Our dream team</em></td> </tr> </tbody> </table> <p>Yet it comes with restriction of Airflow environments, manage dependencies, which could be mitigated with building custom airflow docker image.</p> <p>Moreover, it introduced convenient way of job execution defined by yaml. It’s api is quite transparent, I’ll provide you comments to</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">job</span><span class="pi">:</span>
    <span class="na">resourse_flavor</span><span class="pi">:</span> <span class="s">cpu-16gb</span> <span class="c1"># configures amount of cpu, gpu and ram</span>
    <span class="na">docker_image</span><span class="pi">:</span> <span class="s">python3-11</span> <span class="c1"># sets image </span>
    <span class="na">excecution_time</span><span class="pi">:</span> <span class="s">60 minutes</span> <span class="c1"># time of execution. After job ungracefully shuts</span>
    <span class="na">execution_script</span><span class="pi">:</span> <span class="s">python main.py</span> <span class="c1"># defines script that will be executed through job</span>
</code></pre></div></div> <p>And a way of handling big files from executions through s3</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/architecture/handling_files.excalidraw.png" alt="s3_airflow.png"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Transportation as a service</em></td> </tr> </tbody> </table> <p>Therefore introduced techniques are primarly oriented for effective utilizations of provided features and effective ML team collaboration.</p> <h3 id="problems-">Problems 🚨</h3> <p>Main problem were:</p> <ul> <li>testing models inference and node functionality was extremely on server</li> <li>monitoring of dags execution and data delivery</li> <li>environment setting</li> <li>no reasonable solution for reuse of already prepared dag</li> </ul> <p>I’ll introduce solution for every problem through next paragraphs</p> <h3 id="cli-apps-for-testing">CLI apps for testing</h3> <p>Cli apps facilitate testing as their should behave equally in fast local environment and</p> <p>When app is ready we can have following options</p> <ul> <li>push to Python package storage, from where we’ll pip install it in execution job</li> <li>make a docker image with install cli option</li> </ul> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/architecture/upload.excalidraw.png" alt="s3_airflow.png"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Our dream team</em></td> </tr> </tbody> </table> <h3 id="model-delivery">Model delivery</h3> <p>Also repo contains reproduction code for model. Reproduction is done with usage</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/architecture/model.excalidraw.png" alt="s3_airflow.png"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Training is performed in job, that is called in CI script. Than model proceeds to designated model bucket</em></td> </tr> </tbody> </table> <p>Every option is actually great and should be facilitated for usage</p> <h3 id="pipeline-for-repetitive-code">Pipeline for repetitive code</h3> <p>Main observation was that dags are mostly similar and has structure of Extract Transform Load(ETL).</p> <p>Therefore they can be replaced with simple yaml structure. I’ll provide you with prototype</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">dag</span><span class="pi">:</span> <span class="c1"># dag info</span>
    <span class="na">name</span><span class="pi">:</span> 
    <span class="na">schedule</span><span class="pi">:</span> <span class="s2">"</span><span class="nv"> </span><span class="s">"</span> <span class="c1"># simple cron expression</span>
    <span class="na">base_resourse</span><span class="pi">:</span> <span class="s">cpu</span>
    <span class="na">critical</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">tasks</span><span class="pi">:</span>
  <span class="na">read</span><span class="pi">:</span> <span class="c1"># arbitrary group name</span>
    <span class="na">load_csv</span><span class="pi">:</span> <span class="c1"># arbitrary task name</span>
      <span class="na">operator_type</span><span class="pi">:</span> <span class="s">pg_to_csv</span>
      <span class="na">columns</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">ham</span>
        <span class="pi">-</span> <span class="s">bam</span>
<span class="nn">...</span>
</code></pre></div></div> <p>Such solutions allows to abstract from Airflow and can be scaled via interactive UI. Moreover, it is useful for versioning of code and correction on fly from gitlab editor.</p> <p>Overall pipeline looks like:</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/architecture/templates.excalidraw.png" alt="template.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Gitlab templates blank for each yaml pipeline definition</em></td> </tr> </tbody> </table> <p>There are some open-source, that already implemented yaml declarative approach:</p> <ul> <li>dag-factory: <a href="https://github.com/ajbosco/dag-factory" rel="external nofollow noopener" target="_blank">https://github.com/ajbosco/dag-factory</a> </li> <li>airflow-declarative: <a href="https://github.com/rambler-digital-solutions/airflow-declarative" rel="external nofollow noopener" target="_blank">https://github.com/rambler-digital-solutions/airflow-declarative</a> </li> </ul> <h3 id="environment-variables">Environment variables</h3> <p>Unfortunatelly we don’t have access to environment variables of Airflow. Therefore we have two options:</p> <ul> <li>set environments from UI, which is not scalable</li> <li>set environment of Airflow can be defined through Airflow variables</li> </ul> <p>Second option is better, yet it requires quite long chain for completion.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/architecture/model.excalidraw.png" alt="s3_airflow.png"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Training is performed in job, that is called in CI script. Than model proceeds to designated bucket</em></td> </tr> </tbody> </table> <p>Basically configuration yaml look like that:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">postgres_db_connection</span><span class="pi">:</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">${PG_PASSWORD}</span>
</code></pre></div></div> <p>Bash util <code class="language-plaintext highlighter-rouge">envsubst</code> will fill fields as <code class="language-plaintext highlighter-rouge">${PG_PASSWORD}</code> with respect value from Gitlab CI variables.</p> <p>Before we can start inference we need to deliver our files to production. Our provides can grab files for inference from s3.</p> <p>Repository of airflow and model were separated</p> <h2 id="team">Team</h2> <p>Architecture is seeking for ability for delegating responsibilities</p> <h3 id="responsibility-delegating">Responsibility delegating</h3> <p>Business critical processes requires swift responses for change of production environments . Hence specialists should be able to effectively collaborate in critical situations.</p> <p>Commonly used technique for that is introducing role model for specialists with.</p> <h3 id="airflow-team">Airflow team</h3> <p>Management</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/team.excalidraw.png" alt="team.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Our dream team</em></td> </tr> </tbody> </table> <p>Note that every specialist should be essential, beneficial for and has an ability to master his skills.</p> <h3 id="data-scientist">Data Scientist</h3> <p>Analytic concentrates on novel ideas for models and bring/</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/roles/ds/ds.excalidraw.png" alt="ds.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Provider of novel ideas</em></td> </tr> </tbody> </table> <p>Growth:</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/roles/ds/growth.excalidraw.png" alt="ds_growth.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Stronger algorithm generalization</em></td> </tr> </tbody> </table> <p>Main track of learning is providing more flexible solutions. It includes:</p> <ul> <li>search new ideas, incorporating new solutions</li> <li>creating valence operators, that can handle arbitrary amount and type of data</li> <li>provide best solution for analytic task</li> <li>data quality organization</li> </ul> <h3 id="data-engineer">Data engineer</h3> <p>He knows bases of devops, yet specify his skills in building robust and flexible pipelines. Although role can be modified via</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/roles/engineer/engineer.excalidraw.png" alt="team.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Builds functional operator, scales code</em></td> </tr> </tbody> </table> <p>Engineer is mostly responsible for:</p> <ul> <li>help of analytics with optimal pipeline solution</li> <li>development of new operator for connection</li> <li>bringing</li> </ul> <p>Main track of learning is providing more flexible solutions. It includes:</p> <ul> <li>gluing code with bash</li> <li>creating valent operators, that can handle arbitary amount and type of data</li> <li>provide best solution for analytic task</li> <li>data quality organization</li> </ul> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/roles/engineer/growth.excalidraw.png" alt="team.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Builds functional operator, scales code</em></td> </tr> </tbody> </table> <p>Although he helps to relaxate climax situation. He helps analytic and discuss tests.</p> <h3 id="developer">Developer</h3> <p>Mostly responsible for:</p> <ul> <li>scalability</li> <li>introducing CI building process</li> <li>ease of configuration Therefore role ease building of new dags and their monitoring.</li> </ul> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/roles/developer/developer.excalidraw.png" alt="developer.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Scales and rescales</em></td> </tr> </tbody> </table> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/roles/developer/growth.excalidraw.png" alt="developer.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Developer learns scaling</em></td> </tr> </tbody> </table> <h3 id="cli-as-communication-protocol">CLI as communication protocol</h3> <p>Support for pipeline in working condition is mainly responsibility of engineer therefore he need to make sure, that Data Scientist code is reliable.</p> <p>Cli app coupled with tests is simple, yet effective way to do that:</p> <h3 id="team-interaction">Team interaction</h3> <p>Should be formalized and adversarial for growth. Interaction between engineer and analytic</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/team_protocol.excalidraw.png" alt="team.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Interaction should be objective and implicit</em></td> </tr> </tbody> </table> <p>Will discuss</p> <h3 id="big-csv">Big csv</h3> <p>Suppose pur pipeline succeeds in business application and comes time for scaling. Hence input starts to come in greater amount, which can not be handled with same resources.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/examples/big_csv.excalidraw.png" alt="bit_csv.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Scaling can be painful for DS</em></td> </tr> </tbody> </table> <p>Yet pandas dataframe isn’t best format for handling big data, as it’s not provide memory efficient storage. That can be optimized via challenging more and more tools like Polars, Ray and Spark. Yet business can not always wait for this</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/examples/analytic_hell.excalidraw.png" alt="bit_csv.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Scaling can be painful for Data Scientist</em></td> </tr> </tbody> </table> <p>Therefore, simple bash solution can handle problem more implicitly</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/examples/big_csv_solution.excalidraw.png" alt="big_csv_solution.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Branch and bound</em></td> </tr> </tbody> </table> <p>Engineer can solve problem in one line of code, which can ease first steps and proceeds with studying of goal framework. Re</p> <p>So that they can be gracefully proceeds with analytic codes.</p> <h3 id="critical-job-falls-and-analytic-want-to-revert-to-previous-version">Critical job falls and analytic want to revert to previous version</h3> <p>Developer should</p> <h2 id="code-implementation">Code implementation</h2> <p>Nitty details of implementation</p> <h3 id="s3-environment-organization">s3 environment organization</h3> <h2 id="setting-airflow-variables">Setting Airflow variables</h2> <p>Environments helps to test new ideas</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">airflow.models</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="n">Variable</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">db_url</span><span class="sh">"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="sh">""</span><span class="p">)</span>
<span class="n">Variable</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">my_json_var</span><span class="sh">"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">num1</span><span class="sh">"</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="sh">"</span><span class="s">num2</span><span class="sh">"</span><span class="p">:</span> <span class="mi">42</span><span class="p">},</span> <span class="n">serialize_json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <p>Airflow operators are projected such way, that they change their behaviour with respect to current Airflow variables</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">airflow.models</span> <span class="kn">import</span> <span class="n">Variable</span>

</code></pre></div></div> <h3 id="template-from--yaml-structure">Template from yaml structure</h3> <p>Recall structure of pipeline yaml file</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">group</span><span class="pi">:</span> <span class="c1"># arbitrary group name</span>
    <span class="na">task</span><span class="pi">:</span> <span class="c1"># arbitrary task name</span>
      <span class="na">operator_type</span><span class="pi">:</span> <span class="s">pg_to_csv</span>
      <span class="na">columns</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">ham</span>
        <span class="pi">-</span> <span class="s">bam</span>
</code></pre></div></div> <p>Resulted py file for airflow execution is done with jinja. You can read my code in following <a href="TODO">github</a></p> <p>Note that there is an alternative approach through <code class="language-plaintext highlighter-rouge">globals()</code> as it was done in <a href="https://github.com/rambler-digital-solutions/airflow-declarative" rel="external nofollow noopener" target="_blank">airflow-declarative</a>. Yet it less explicit as it doesn’t produce resulted python files.</p> <h3 id="node-based-programming">Node based programming</h3> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/airflow_automation/node_based/ui.png" alt="ui.ppg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Open source solution for class connection</em></td> </tr> </tbody> </table> <p>For ease of building new dags I introduced <a href="https://github.com/NMashalov/PyVisGraph" rel="external nofollow noopener" target="_blank">solution</a> based on <a href="https://github.com/jagenjo/litegraph.js/blob/master/build/litegraph.js" rel="external nofollow noopener" target="_blank">LiteGraph</a>.</p> <p>Solution was highly inspired by ComfyUI pipelining tool for Stable Diffusion.</p> <h2 id="summary">Summary</h2> <p>Thank for your reading. Hope that provide some intuition for your team. I compiled article insights for you</p> <ul> <li>Role model is convenient way of organizing team. Primarily, there are three basic roles: Data Scientist - business insights seekers, Engineer - support and critique, Developer - wires, monitors and rescales</li> <li>Yaml is convenient both for defining pipelines and configs</li> <li>decoupling of model and airflow repo can be done via s3</li> <li>partite s3 for models. That allows flexible versioning of data and models.</li> <li>cli is nice interface for interaction between engineer and data scientists</li> </ul> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Nikita Mashalov. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>