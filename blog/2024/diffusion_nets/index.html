<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Diffusion net notes | Nikita Mashalov</title> <meta name="author" content="Nikita Mashalov"> <meta name="description" content="Article argues with and elucidating diffusion net from perspective of gradual correction and bring insights from physics. Article suggests alternative explanation via concept of continious storage naturally comming out of boltzman distribution. Proposal is built with providing intuition of underlying physical process .Elaborationj idea it bring different statistics as fermi and boson as"> <meta name="keywords" content="Mashalov Nikita, machine learning, artificial intelligence, AI"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%94%AD&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nmashalov.github.io/blog/2024/diffusion_nets/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?6185d15ea1982787ad7f435576553d64"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Nikita Mashalov</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Diffusion net notes</h1> <p class="post-meta">January 10, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Key physical ideas:</p> <ul> <li>diffusion models are continuous storages that use heat equations for search in high-dimensional space</li> <li>search is performed via image cooling, building storage is done via reversed process</li> <li>sampling techniques can be studied from perspective of school physics thermal process like adiabatic, isothermal and more</li> </ul> <p>Many ideas in top papers can be derived from school physics, which are hard to be seen due to obfuscation of terminology 😔. Hope that will help you in your research and experiments.</p> <h2 id="introduction">Introduction</h2> <p>File systems are organized hierachicallly. It helps to preserve <em>context</em> and <em>hasten</em> search</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/file_storage.excalidraw.png" alt="map.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>File storage provides way of information organization</em></td> </tr> </tbody> </table> <p>But happens if wants to do <em>continuate</em> hierarchy. How it will look like, what properties will it have?</p> <h3 id="physics-matter">Physics matter</h3> <p>In computer science methods using energy are called <em>energy-based</em> and are mostly popularized via Yann LeCun.</p> <p>In physics concept of continuous hierarchy comes naturally from observation of energy spectre of gas \(p(E) = \frac{exp(-\frac{E}{T})}{Z}\)</p> <p>Distribution is called Boltzman and explains probability of particle. You may argue how probability refers to files. So I’ll share distribution of files under energy.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/energy_levels.excalidraw.png" alt="map.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Continious file storage</em></td> </tr> </tbody> </table> <p>See, exponent in probability perfectly matches with idea in hierarchy on every level number of files should grow, therefore we will observe.</p> <h2 id="terminology">Terminology</h2> <p>In section we will refer to physics terminology, which may seem more familiar as their corresponds to nature. I have prepared some beautiful pictures for you to guide through main concepts of temperature, free energy and gaussian noise.</p> <h3 id="temperature">Temperature</h3> <p>Temperature gives average energy of particle in system by simple equation</p> <p>\(E = d/2 T\) ,where $d$ is a dimension of space and $T$ is temperature.</p> <p>Cold is training pictures, hot is initial gaussian. Let’s see how temperature varies distribution</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/boltzman.gif" alt="map.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>High temperature corresponds allows more states</em></td> </tr> </tbody> </table> <h3 id="free-energy">Free energy</h3> <p>$Z$ in normalization is tightly connected with concept of <em>Free energy</em>. In layman terms is maximal energy that you can get from battery considering lack of thermal energy.</p> <p>Physict write</p> \[F = U - TS\] <p>,where $U$ is inner energy, $S$ - entropy, $T $-temperature of system. Informally, it’s a gap between ordered - potential and unordered - kinetic energy.</p> <p>Fundamental principle of universe is minimization of this gap.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/universe.excalidraw.png" alt="map.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Universe is quite lazy. It tends to minimize free energy</em></td> </tr> </tbody> </table> <p>This concept although comes in motion, where it has a representation of Lagrangian</p> \[L = T - V\] <p>This principle is crucial in bayessian optimization and model selection.</p> <p>By the way so called KL-divergence is actually a free energy 🤯.</p> <h3 id="gaussian-noise-is-hierarchical">Gaussian noise is hierarchical</h3> <p>The most important thing about gaussian, that it’s rescales. If you average random gaussian variables you’ll again get gaussian, but at greater scale</p> <p>\(\sum \xi \sim \mathbf{N}(0,N), \xi \sim \mathbf{N}(0,1)\) That’s it gaussian noise is hierarchical properties as it seamlessly accumulate information from is ancestors.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/noise_hierarchy.excalidraw.png" alt="cycle.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Even noise can build hierarchy</em></td> </tr> </tbody> </table> <p>And help her a lot with our noise task</p> <h2 id="what-actually-happens-through-denoising-process">What actually happens through denoising process?</h2> <p>This chapter gradually steps from concept of file storage to diffusion nets. Explains concepts of locality</p> <h3 id="process">Process</h3> <p>Network learns gradually to correct mistakes. This is great explanation, but intuition for building your own approach.</p> <p>Let’s recall main diffusion equation</p> \[{\displaystyle x_{t}={\sqrt {1-\beta _{t}}}x_{t-1}+{\sqrt {\beta _{t}}}z_{t}}\] <p>See $\beta$ in diffusion is reverse temperature $\frac{1}{T}$ and we’ll built intuition why it is useful</p> <p>I argue that this process is actually a thermal cycle</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/thermal_cycle.excalidraw.png" alt="map.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center">*Kolmogorow writes describes thermal process. Can you estimate if energy conversion efficiency $\eta$ :)? *</td> </tr> </tbody> </table> <p>But how it’s possible? I mean GPU heats when train. Yeah refrigiator of cooler does it too 🤯. But then he transverse heat to atmosphere, so it can grab heat again. It’s called reverse carnot cycle</p> <p>One more suggestion before me may build theory. Diffusion build similarity of objects based on their similarity in more.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/similarity.excalidraw.png" alt="map.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>You want to know something similar. Hmm.. just heat it</em></td> </tr> </tbody> </table> <p>So, what is actually happening, through forward process is a heating of images to build hierarchy based on similarity.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/distribution.excalidraw.png" alt="distribtuion.jpg"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Distribution hierarchy</em></td> </tr> </tbody> </table> <p>What’s more temperature naturally sets scale of</p> <h3 id="how-that-happens">How that happens?</h3> <p>It happens through local minimization of local free energy on manifold. Free energy is a metric of best cataloging of whole manifold, score function is it’s local gradient.</p> \[score = - \frac{\partial F}{x}\] <p>That’s it by minimization of score you build perfect catalogue and your diffusion net know have map. That means that recataloging is done locally. Starting from shelfs</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/map.excalidraw.png" alt="map.png"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Map shows direction on where step further from all point</em></td> </tr> </tbody> </table> <p>So that diffusion can effectively catalog all info from pictures. Every step is recataloging info in best format possible. Actually it means that net builds <em>geodesics</em> on manifold.</p> <h3 id="how-net-understand-direction">How net understand direction?</h3> <p>For understanding let’s write small distortion of distribution in energy using Taylor series :</p> \[q(E + \Delta E) = q(E) + \nabla_E q(E) \Delta E\] <p>For energy based gradient can be derived as</p> \[p(E) = \frac{exp(-\frac{E}{T})}{Z} \\ \nabla_E p = - \frac{exp(-\frac{E}{T})}{Z \cdot T} \\\] <p>So that relation between probabilities of distorted and undistorted energy levels is given by:</p> \[\frac{q(E+\Delta E)}{q(E)} = 1 - \Delta E /T\] <p>Note that relation between levels doesn’t depend on current energy! Hierarchy order depends only on temperature. This property is important is at it brings continuous symmetry of translation in corresponding algebra.</p> <p>Direction is built from gradient of $\nabla_x \ln q_x$, which in literature is noted as <em>score</em>.</p> <p>Following scores builds shortest path from one point to another on manifold. Yet geodesic may not always desirable.</p> <p>Recall train loss of diffusion net:</p> \[\sum_{t=2}^T KL(q(x_{t-1}|x_t,x_0) \| p_\theta(x_{t-1}|x_t))\] <p>It is hard to ascertain what that loss</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/catalog.excalidraw.png" alt="catalog.png"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Diffusion does it on every hierarchy level</em></td> </tr> </tbody> </table> <p>Note that every process is decomposed. You can train on any task to be better in whole. This decomposition idea, was introduced in simpler loss</p> \[\mathrm{E}_{t,\epsilon_t\sim N(0,1), x_0}\left[\|\epsilon_t - \epsilon_\theta (\sqrt{\bar{\alpha}} x_0 + \sqrt{1-\bar{\alpha}}\epsilon_t)\|^2\right]\] <p>Don’t be messed with brackets. $\sqrt{\bar{\alpha}} x_0 + \sqrt{1-\bar{\alpha}}\epsilon_t$ is an argument of $\epsilon_\theta$, which to corresponds to neural net prediction.</p> <p>Notice that “simple” equation is overcomplicated with discrete timestamps. Physics perspective doesn’t restrict special spaces.</p> <h3 id="you-can-model-sampling-techniques-as-thermal-process">You can model sampling techniques as thermal process</h3> <p>Euler sampling is isothermal as it brings equal portions of heat on each step.</p> <h3 id="why-we-need-neural-nets">Why we need neural nets?</h3> <p>Because their are very good at learning <em>continuous symmetries</em>. Therefore they are great in interpolating, which is great property for</p> <p>You can learn about symmetries from my other blog.</p> <h2 id="conclusions">Conclusions</h2> <p>I’ll provide you key bullets</p> <ul> <li>training set is cold 🥶, original noise is very hot 🥵</li> <li>diffusion iteratively cools 🧊 source noise</li> <li>it trains to do that via heating 🔥</li> <li>you can use school physics to study diffusion</li> </ul> <p>See, you can even build optimal diffusion through Carno cycle.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/assets/img/posts/diffusion_nets/carnot.excalidraw.png" alt="carno.png"></th> </tr> </thead> <tbody> <tr> <td style="text-align: center"><em>Optimal cycle for cooling and heating</em></td> </tr> </tbody> </table> <p>It’s very interesting, if it is possible to measure</p> <h2 id="related-themes">Related themes</h2> <p>Here some themes that are tightly related, but I am still strugling to wrench them to article</p> <h3 id="fokker-plank-equation">Fokker-Plank equation</h3> \[\frac{\partial}{\partial t} p(x,t) = - \frac{\partial}{\partial x}[\mu(x,t)p(x,t)] + \partial{}{}\] <h3 id="quantum-perspective">Quantum perspective</h3> <p>Energy level are actually discrete, but are expanded through brownian motion of particles.</p> <h2 id="normal-distribution-information-geometry-approach">Normal distribution. Information geometry approach</h2> <p>It can be shown that riemanian metric of gaussian distribution is equal to: \(g = \frac{1}{\sigma^2}(d\mu^2+2d\sigma^2)\)</p> <p>That speculations is very important due to fact it’s curvature defines hyperbolic space as them naturally hierarchical</p> <h3 id="diffusion-maps">Diffusion maps</h3> <p>Is approach for dimension reduction similar as PCA and t-SNE. You can read <a href="https://en.wikipedia.org/wiki/Diffusion_map" rel="external nofollow noopener" target="_blank">more</a></p> <h3 id="connection-to-optimal-transport">Connection to optimal transport</h3> <p>Yandex research paper</p> <p>Two steps:</p> <ol> <li>Transforming ODE to probability flow ODE</li> </ol> \[dx= -[x+\nabla_x \log p_t(x)]dt\] <ol> <li>Encoder map For a given distribution µ0 and a timestep t, let us denote the flow generated by this vector field as Eµ0 (t, ·). I.e., a point x ∼ µ0 is mapped to Eµ0 (t, x) when transported along the vector field for a time t. The ‘final’ encoding map is obtained when t → ∞, i.e,</li> </ol> \[E_{\mu_0}(x) = \lim_{t \rightarrow \infty} E_{\mu_0}(t,x)\] <p>Note that $E_{\mu_0}$ implicitly depends on all the intermediate densities µt obtained from the diffusion process (or the Fokker-Planck equation).</p> <p>The authors of <a href="https://arxiv.org/abs/2108.01073" rel="external nofollow noopener" target="_blank">Meng et al.</a> (2021) proposed to view diffusion models as a discretization of certain stochastic differential equations. SDEs generalize standard ordinary differential equations (ODEs) by injecting random noise into dynamics. Specifically, the diffusion process specified by Equation (1) is a discretization of the following SDE:</p> \[dx = -\frac{1}{2} \beta(t) xdt + \sqrt{\beta(t)} d\omega\] <p>r. It can be shown that the trajectory {µt}∞ t=0, obtained by solving the Fokker-Planck equation</p> <h2 id="useful-resources">Useful resources</h2> <p>Blogs:</p> <ol> <li>Markov chains https://bjlkeng.io/posts/markov-chain-monte-carlo-mcmc-and-the-metropolis-hastings-algorithm/</li> </ol> <p>Videos:</p> <ol> <li>https://www.youtube.com/watch?v=hbIfrLefwzw</li> </ol> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Nikita Mashalov. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?9b43d6e67ddc7c0855b1478ee4c48c2d" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>